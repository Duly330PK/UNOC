<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>UNOC - Unified NOC UI</title>
    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        :root {
            --bg-color: #1a1a1a;
            --header-bg: #2a2a2a;
            --panel-bg: #242424;
            --border-color: #444;
            --text-color: #e0e0e0;
            --text-muted: #aaa;
            --accent-color: #4CAF50;
            --accent-red: #F44336;
            --accent-green: #4CAF50;
            --font-size-normal: 14px;
            --font-size-large: 16px;
        }

        body, html {
            margin: 0; padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color); color: var(--text-color);
            height: 100vh; overflow: hidden; display: flex; flex-direction: column;
        }

        header {
            background-color: var(--header-bg);
            padding: 10px 20px;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }
        
        h1 { font-size: 1.5em; }
        h2 { font-size: 1.2em; border-bottom: 1px solid #555; padding-bottom: 8px; margin: 0 0 12px 0; }

        #main-wrapper {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            height: calc(100% - 100px);
        }

        #top-section {
            display: flex;
            flex-grow: 1;
            height: 70%;
        }

        #view-container {
            width: 75%;
            height: 100%;
            position: relative;
        }

        #network-container, #map-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--bg-color);
        }

        #map-container { z-index: 10; visibility: hidden; }
        
        #view-toggle {
            position: absolute; top: 10px; right: 10px; z-index: 20;
        }
        
        #view-toggle button {
            width: auto; padding: 8px 12px; background-color: rgba(42, 42, 42, 0.8);
        }

        #sidebar {
            width: 25%; height: 100%;
            display: flex; flex-direction: column;
            background-color: var(--panel-bg);
            border-left: 1px solid var(--border-color);
        }

        .panel {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            overflow-y: auto;
            font-size: var(--font-size-normal);
        }
        
        #properties-panel { flex-grow: 1; }

        #bottom-panel {
            height: 30%;
            border-top: 1px solid var(--border-color);
            display: flex;
            background-color: var(--panel-bg);
        }

        .bottom-column {
            flex: 1;
            padding: 15px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        #event-log-panel {
            border-right: 1px solid var(--border-color);
        }

        #event-log, #cli-output {
            flex-grow: 1;
            overflow-y: auto;
            font-family: monospace;
            font-size: 13px;
            line-height: 1.4;
        }
        
        #event-log { list-style: none; padding: 0; margin: 0; }
        #event-log li { padding: 4px 0; border-bottom: 1px solid #333; }
        #event-log li:first-child { color: var(--accent-color); }

        #cli-input-wrapper {
            display: flex;
            align-items: center;
            border-bottom: 1px solid #333;
            margin-bottom: 10px;
            padding-bottom: 5px;
        }
        #cli-prompt { font-family: monospace; padding-right: 8px; font-size: var(--font-size-large); color: var(--text-muted); }

        #cli-input {
            flex-grow: 1;
            background-color: transparent;
            border: none;
            color: #00ff00;
            font-family: monospace;
            font-size: var(--font-size-large);
            padding: 8px 0;
            margin: 0;
        }
        #cli-input:focus { outline: none; }

        input, button, select {
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
            border: 1px solid #666;
            background-color: #333;
            color: var(--text-color);
            font-size: var(--font-size-normal);
        }
        select { width: 100%; }
        .button-group, .input-group { display: flex; gap: 10px; }
        .input-group input { flex-grow: 1; margin-bottom: 0; }
        .input-group button { margin-bottom: 0; }

        button { cursor: pointer; background-color: #007BFF; border-color: #007BFF; font-weight: bold; }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #555; border-color: #666; cursor: not-allowed; }

        #hud { display: flex; justify-content: space-around; background-color: #2c2c2c; padding: 10px; border-bottom: 1px solid #444; flex-shrink: 0; }
        .hud-item { text-align: center; }
        .hud-item h3 { margin: 0; font-size: 14px; color: #aaa; text-transform: uppercase; }
        .hud-item p { margin: 5px 0 0; font-size: 22px; font-weight: bold; }

        #properties-content table, #ring-info table { width: 100%; border-collapse: collapse; font-size: var(--font-size-normal); }
        #properties-content th, #properties-content td, #ring-info td { padding: 8px; text-align: left; border-bottom: 1px solid #333; }
        #properties-content th { width: 35%; color: var(--text-muted); }
        
        #ring-panel .status-blocking { color: #FFC107; font-weight: bold; }
        #ring-panel .status-forwarding { color: var(--accent-green); font-weight: bold; }
        
        .loader { color: var(--text-muted); font-style: italic; }

        /* MODAL STYLES */
        #modal-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #modal-overlay.hidden {
            display: none;
        }
        #modal-box {
            background-color: var(--panel-bg);
            padding: 25px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            width: 90%;
            max-width: 500px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        #modal-box h2 {
            margin-top: 0;
            border-bottom: none;
        }
        #modal-message {
            font-size: var(--font-size-normal);
            line-height: 1.5;
        }
        #modal-buttons {
            margin-top: 20px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        #modal-buttons button {
            margin-bottom: 0;
        }
        .modal-btn-primary {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
        }
        .modal-btn-danger {
            background-color: var(--accent-red);
            border-color: var(--accent-red);
        }
        .modal-btn-secondary {
            background-color: #555;
            border-color: #666;
        }
    </style>
</head>
<body>
    <header><h1>UNOC - Netzwerk Visualisierung</h1></header>

    <div id="hud">
        <div class="hud-item"><h3>Geräte Online</h3><p id="hud-devices">...</p></div>
        <div class="hud-item"><h3>Links Up</h3><p id="hud-links">...</p></div>
        <div class="hud-item"><h3>Alarme</h3><p id="hud-alarms">...</p></div>
    </div>

    <div id="main-wrapper">
        <div id="top-section">
            <div id="view-container">
                <div id="network-container"></div>
                <div id="map-container"></div>
                <div id="view-toggle">
                    <button id="toggle-btn">Kartenansicht</button>
                </div>
            </div>
            <aside id="sidebar">
                <div id="properties-panel" class="panel">
                    <h2>Eigenschaften</h2>
                    <div id="properties-content" class="loader">Kein Element ausgewählt</div>
                </div>
                <div id="ring-panel" class="panel">
                    <h2>Ring Status</h2>
                    <div id="ring-info" class="loader">Lade Ring-Status...</div>
                </div>
                <div id="controls-panel" class="panel">
                    <h2>Steuerung</h2>
                    <div class="button-group">
                        <button id="undo-btn" disabled>Undo</button>
                        <button id="redo-btn" disabled>Redo</button>
                    </div>
                </div>
                <div id="scenario-panel" class="panel">
                    <h2>Szenarien</h2>
                    <select id="splitter-select"></select>
                    <button id="fiber-cut-btn">Faserschnitt simulieren</button>
                </div>
                <div id="snapshot-panel" class="panel">
                    <h2>Snapshots</h2>
                    <div class="input-group">
                        <input type="text" id="snapshot-name" placeholder="Snapshot-Name...">
                        <button id="save-snapshot-btn">Speichern</button>
                        <button id="load-snapshot-btn">Laden</button>
                    </div>
                </div>
            </aside>
        </div>
        <div id="bottom-panel">
            <div id="event-log-panel" class="bottom-column">
                <h2>Event Log</h2>
                <ul id="event-log"><li class="loader">Lade Events...</li></ul>
            </div>
            <div id="cli-panel" class="bottom-column">
                <h2>Command Line</h2>
                <div id="cli-input-wrapper">
                    <span id="cli-prompt">UNOC></span>
                    <input type="text" id="cli-input" placeholder="Befehl eingeben (z.B. 'help')...">
                </div>
                <div id="cli-output"></div>
            </div>
        </div>
    </div>

    <!-- Modal Structure -->
    <div id="modal-overlay" class="hidden">
        <div id="modal-box">
            <h2 id="modal-title"></h2>
            <p id="modal-message"></p>
            <div id="modal-buttons"></div>
        </div>
    </div>

    <script>
        // --- Globale Variablen ---
        const backendUrl = "http://127.0.0.1:5000";
        let network = null, map = null, nodes = new vis.DataSet([]), edges = new vis.DataSet([]);
        let mapMarkers = {}, mapLines = {}, currentView = 'topo', eventPollInterval = null;

        // --- Visuelle Stile ---
        const statusToColor = {
            online: { border: "#4CAF50", background: "#2e7d32" }, offline: { border: "#F44336", background: "#c62828" },
            maintenance: { border: "#FFC107", background: "#ffa000" }, up: { color: "#4CAF50", highlight: "#66BB6A" },
            down: { color: "#F44336", highlight: "#EF5350" }, degraded: { color: "#FFC107", highlight: "#FFCA28" },
            blocking: { color: "#FFC107", highlight: "#FFCA28" }
        };
        const getEdgeLeafletColor = (status) => (statusToColor[status] || { color: '#9E9E9E' }).color;

        // --- Initialisierung & Datenabruf ---
        async function initialize() {
            try {
                const response = await fetch(`${backendUrl}/api/topology`);
                const topology = await response.json();
                
                initializeNetworkView(topology);
                initializeMapView(topology);
                
                populateSplitterDropdown(topology.devices);
                updateRingPanel(topology);

                if (!eventPollInterval) {
                    setupEventListeners();
                    pollForUpdates();
                    eventPollInterval = setInterval(pollForUpdates, 2500);
                }
            } catch (e) { console.error("Fehler bei der Initialisierung:", e); }
        }

        function initializeNetworkView(topology) {
            nodes.clear(); edges.clear();
            nodes.add(topology.devices.map(formatDeviceToNode));
            edges.add(topology.links.map(formatLinkToEdge));
            if (!network) {
                const container = document.getElementById('network-container');
                network = new vis.Network(container, { nodes, edges }, {});
            }
        }

        function initializeMapView(topology) {
            if (map) return;
            map = L.map('map-container').setView([52.0, 7.5], 9);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OpenStreetMap &copy; CARTO', maxZoom: 20
            }).addTo(map);

            topology.devices.forEach(device => {
                if (device.coordinates) {
                    mapMarkers[device.id] = L.marker(device.coordinates).addTo(map)
                        .bindPopup(`<b>${device.id}</b><br>${device.type}`);
                }
            });
            topology.links.forEach(link => {
                const source = topology.devices.find(d => d.id === link.source);
                const target = topology.devices.find(d => d.id === link.target);
                if (source?.coordinates && target?.coordinates) {
                    mapLines[link.id] = L.polyline([source.coordinates, target.coordinates], { 
                        color: getEdgeLeafletColor(link.status), weight: 3,
                        dashArray: link.status === 'blocking' ? '5, 5' : null
                    }).addTo(map);
                }
            });
        }

        // --- Update & Sync Funktionen ---
        async function pollForUpdates() {
            try {
                const [eventsRes, historyRes, statsRes, topoRes] = await Promise.all([
                    fetch(`${backendUrl}/api/events`), fetch(`${backendUrl}/api/history/status`),
                    fetch(`${backendUrl}/api/topology/stats`), fetch(`${backendUrl}/api/topology`)
                ]);
                
                if (!eventsRes.ok || !historyRes.ok || !statsRes.ok || !topoRes.ok) throw new Error("Backend nicht erreichbar");

                const events = await eventsRes.json();
                const historyStatus = await historyRes.json();
                const stats = await statsRes.json();
                const topology = await topoRes.json();
                
                const eventLog = document.getElementById('event-log');
                if (eventLog.children.length === 0 || events[0] !== eventLog.children[0]?.textContent) {
                    eventLog.innerHTML = events.map(e => `<li>${e}</li>`).join('');
                    refreshTopologyDisplay(topology);
                }
                updateHud(stats);
                updateHistoryButtons(historyStatus);
            } catch (error) { console.error("Polling-Fehler:", error); }
        }

        function refreshTopologyDisplay(topology) {
            nodes.update(topology.devices.map(formatDeviceToNode));
            edges.update(topology.links.map(formatLinkToEdge));
            updateRingPanel(topology);
            syncMapWithState(topology);
        }

        function syncMapWithState(topology) {
            if (!map) return;
            topology.links.forEach(link => {
                if (mapLines[link.id]) {
                    mapLines[link.id].setStyle({
                        color: getEdgeLeafletColor(link.status),
                        dashArray: link.status === 'blocking' ? '5, 5' : null
                    });
                }
            });
        }
        
        // --- UI-Steuerung & Hilfsfunktionen ---
        function updateHud(stats) {
            document.getElementById('hud-devices').textContent = `${stats.devices_online} / ${stats.devices_total}`;
            document.getElementById('hud-links').textContent = `${stats.links_up} / ${stats.links_total}`;
            const alarmsEl = document.getElementById('hud-alarms');
            alarmsEl.textContent = stats.alarms;
            alarmsEl.style.color = stats.alarms > 0 ? 'var(--accent-red)' : 'var(--accent-green)';
        }
        
        function updateHistoryButtons(status) {
            document.getElementById('undo-btn').disabled = !status.can_undo;
            document.getElementById('redo-btn').disabled = !status.can_redo;
        }

        function updateRingPanel(topology) {
            const ringInfoDiv = document.getElementById('ring-info');
            if (!topology.rings?.length) {
                ringInfoDiv.innerHTML = '<span class="loader">Keine Ringe definiert.</span>';
                return;
            }
            let html = '<table>';
            topology.rings.forEach(ring => {
                const rpl = topology.links.find(l => l.id === ring.rpl_link_id);
                if (rpl) {
                    const statusClass = rpl.status === 'blocking' ? 'status-blocking' : 'status-forwarding';
                    html += `<tr><td><b>${ring.name}</b></td><td class="${statusClass}">${rpl.status.toUpperCase()}</td></tr>`;
                }
            });
            ringInfoDiv.innerHTML = html + '</table>';
        }

        function populateSplitterDropdown(devices) {
            const select = document.getElementById('splitter-select');
            select.innerHTML = '';
            devices.filter(d => d.type.toLowerCase() === 'splitter').forEach(d => {
                const option = document.createElement('option');
                option.value = d.id;
                option.textContent = d.id;
                select.appendChild(option);
            });
        }

        function renderProperties(data) {
            const content = document.getElementById('properties-content');
            if (!data) {
                content.innerHTML = '<span class="loader">Kein Element ausgewählt</span>';
                return;
            }
            let table = '<table>';
            for (const [k, v] of Object.entries(data)) {
                let displayValue = v;
                if (k === 'coordinates' && Array.isArray(v)) displayValue = `${v[0].toFixed(4)}, ${v[1].toFixed(4)}`;
                else if (typeof v === 'object' && v !== null) displayValue = JSON.stringify(v);
                table += `<tr><th>${k}</th><td>${displayValue}</td></tr>`;
            }
            content.innerHTML = table + '</table>';
        }
        
        function toggleView() {
            const mapContainer = document.getElementById('map-container');
            const toggleBtn = document.getElementById('toggle-btn');
            const isTopo = currentView === 'topo';
            mapContainer.style.visibility = isTopo ? 'visible' : 'hidden';
            toggleBtn.textContent = isTopo ? 'Topologieansicht' : 'Kartenansicht';
            currentView = isTopo ? 'map' : 'topo';
            if (isTopo) map.invalidateSize();
        }

        // --- MODAL FUNCTIONS ---
        function showModal(title, message, buttons = [{ text: 'OK', class: 'modal-btn-primary', callback: hideModal }]) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            const buttonContainer = document.getElementById('modal-buttons');
            buttonContainer.innerHTML = '';
            buttons.forEach(btnInfo => {
                const button = document.createElement('button');
                button.textContent = btnInfo.text;
                button.className = btnInfo.class || 'modal-btn-secondary';
                button.onclick = () => {
                    hideModal();
                    if (btnInfo.callback) btnInfo.callback();
                };
                buttonContainer.appendChild(button);
            });
            document.getElementById('modal-overlay').classList.remove('hidden');
        }

        function hideModal() {
            document.getElementById('modal-overlay').classList.add('hidden');
        }

        function setupEventListeners() {
            network.on('click', params => {
                const elementId = params.nodes[0] || params.edges[0];
                const dataset = params.nodes.length ? nodes : edges;
                renderProperties(elementId ? dataset.get(elementId).data : null);
            });

            document.getElementById('toggle-btn').addEventListener('click', toggleView);
            document.getElementById('undo-btn').addEventListener('click', () => postAction('/api/simulation/undo'));
            document.getElementById('redo-btn').addEventListener('click', () => postAction('/api/simulation/redo'));
            document.getElementById('fiber-cut-btn').addEventListener('click', simulateFiberCut);
            document.getElementById('save-snapshot-btn').addEventListener('click', saveSnapshot);
            document.getElementById('load-snapshot-btn').addEventListener('click', loadSnapshot);
            document.getElementById('cli-input').addEventListener('keydown', handleCliCommand);
        }

        // --- Aktionen (POST-Requests) ---
        async function postAction(endpoint, payload = {}) {
            try {
                const res = await fetch(`${backendUrl}${endpoint}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!res.ok) throw new Error((await res.json()).description || "Unbekannter Backend-Fehler");
                await pollForUpdates();
            } catch (error) {
                console.error("Aktion fehlgeschlagen:", error);
                showModal('Aktion fehlgeschlagen', error.message);
            }
        }

        function simulateFiberCut() {
            const nodeId = document.getElementById('splitter-select').value;
            if (nodeId) {
                showModal(
                    'Faserschnitt simulieren',
                    `Soll ein Faserschnitt bei ${nodeId} wirklich simuliert werden?`,
                    [
                        { text: 'Abbrechen', class: 'modal-btn-secondary' },
                        { text: 'Simulieren', class: 'modal-btn-danger', callback: () => postAction('/api/simulation/fiber-cut', { node_id: nodeId }) }
                    ]
                );
            }
        }

        function saveSnapshot() {
            const name = document.getElementById('snapshot-name').value.trim();
            if (name) {
                 postAction('/api/snapshot/save', { name });
            } else {
                showModal('Fehler', 'Bitte einen Namen für den Snapshot eingeben.');
            }
        }

        function loadSnapshot() {
            const name = document.getElementById('snapshot-name').value.trim();
            if (name) {
                showModal(
                    'Snapshot laden',
                    `Soll der Snapshot '${name}' wirklich geladen werden? Alle ungespeicherten Änderungen gehen verloren.`,
                    [
                        { text: 'Abbrechen', class: 'modal-btn-secondary' },
                        { text: 'Laden', class: 'modal-btn-primary', callback: () => postAction('/api/snapshot/load', { name }) }
                    ]
                );
            } else {
                 showModal('Fehler', 'Bitte den Namen des zu ladenden Snapshots eingeben.');
            }
        }

        function handleCliCommand(event) {
            if (event.key !== 'Enter') return;
            const input = event.target;
            const commandStr = input.value.trim();
            if (!commandStr) return;
            
            const cliOutput = document.getElementById('cli-output');
            cliOutput.innerHTML += `<div><span style="color: var(--text-muted);">UNOC></span> ${commandStr}</div>`;
            
            const [command, ...args] = commandStr.split(' ');
            const arg = args.join(' ');

            if (command === "help") {
                const helpText = `
                    <div style="color: var(--accent-color);">Verfügbare Befehle:</div>
                    <div><strong>undo</strong> - Macht die letzte Aktion rückgängig.</div>
                    <div><strong>redo</strong> - Wiederholt die letzte rückgängig gemachte Aktion.</div>
                    <div><strong>cut &lt;node_id&gt;</strong> - Simuliert einen Faserschnitt am angegebenen Knoten.</div>
                    <div><strong>link-down &lt;link_id&gt;</strong> - Setzt den Status eines Links auf 'down'.</div>
                    <div><strong>link-up &lt;link_id&gt;</strong> - Setzt den Status eines Links auf 'up'.</div>
                `;
                cliOutput.innerHTML += helpText;
            } else if (command === "undo") {
                postAction('/api/simulation/undo');
            } else if (command === "redo") {
                postAction('/api/simulation/redo');
            } else if (command === "cut" || command === "fiber-cut") {
                postAction('/api/simulation/fiber-cut', { node_id: arg });
            } else if (command.startsWith("link-")) {
                postAction(`/api/links/${arg}/status`, { status: command.split("-")[1] });
            } else {
                cliOutput.innerHTML += `<div style="color: var(--accent-red);">Unbekannter Befehl: '${command}'. Geben Sie 'help' ein für eine Liste der Befehle.</div>`;
            }
            
            cliOutput.scrollTop = cliOutput.scrollHeight;
            input.value = '';
        }

        // --- Hilfsfunktionen ---
        const formatDeviceToNode = d => ({id: d.id, label: `${d.type}\n(${d.id})`, shape: 'box', color: statusToColor[d.status], font: { color: '#ffffff' }, data: d});
        
        function formatLinkToEdge(l) {
            return {
                id: l.id,
                from: l.source,
                to: l.target,
                color: statusToColor[l.status],
                arrows: 'to, from',
                dashes: l.status === 'blocking' ? [5, 5] : false,
                data: l,
                label: l.id, // Display the link ID as a label
                font: {
                    color: '#aaa', // Muted color for the label
                    size: 11,
                    align: 'top',
                    strokeWidth: 3,
                    strokeColor: '#1a1a1a' // Background color for better readability
                }
            };
        }

        document.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>
